<% content_for :title, 'Your Account' %>

<div class="sm:w-7/8 w-full mx-auto">
  <div class="mb-4 flex flex-wrap gap-2 items-center justify-between">
    <%= link_to root_path, class: 'btn btn-sm btn-secondary btn-muted gap-1.5 [view-transition-name:back-btn]' do %>
      <%= inline_svg_tag 'icons/arrow-left.svg', class: 'size-3.5 shrink-0' %>
      <span>Back Home</span>
    <% end %>
  </div>

  <div class="mb-10 pb-10 border-b border-neutral-200 dark:border-neutral-800 flex flex-wrap items-end justify-between gap-2">
    <div>
      <h1 class="heading">Security</h1>
      <p class="text-sm text-muted mt-1">Manage your passkeys and active sessions to secure your account.</p>
    </div>
  </div>

  <!-- Passkeys Section -->
  <div class="mb-10 pb-10 border-b border-neutral-200 dark:border-neutral-800">
    <div class="mb-4 flex flex-wrap items-end justify-between gap-2">
      <div>
        <h2 class="subheading">Passkeys</h2>
        <p class="text-sm text-muted mt-1">
          Passkeys provide secure, passwordless authentication using biometrics or device PIN.
        </p>
        <div class="card mt-2 flex items-start gap-2 md:gap-3">
          <%= inline_svg_tag 'icons/info.svg', class: 'size-4 shrink-0 text-soft' %>
          <p class="text-soft text-xs text-pretty">Supported on modern browsers and devices with Touch ID, Face ID, Windows Hello, or security keys.</p>
        </div>
      </div>
      
      <%= link_to new_passkey_path, class: 'btn btn-primary gap-1.5' do %>
        <%= inline_svg_tag 'icons/plus.svg', class: 'size-4 shrink-0' %>
        <span>New Passkey</span>
      <% end %>
    </div>

    <div class="mb-6">
      <% if @passkeys.any? %>
        <ul class="flex flex-col gap-2">
          <% @passkeys.each do |passkey| %>
            <li class="card flex justify-between items-center gap-4" style='view-transition-name: passkey-<%= passkey.id %>'>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-semibold text-soft truncate">Passkey <%= passkey.id %></span>
                  <% if passkey.updated_at > 7.days.ago %>
                    <%= tag.span('Recently Used', class: 'tag tag-accepted text-xs') %>
                  <% end %>
                </div>
                <div class="space-y-0.5">
                  <p class="text-xs text-muted">
                    Created: <span class="font-semibold text-soft"><%= local_time(passkey.created_at) %></span>
                  </p>
                </div>
              </div>

              <%= button_to passkey_path(passkey),
                  method: :delete,
                  data: { 
                    turbo_confirm: "Are you sure you want to delete this passkey? You won't be able to use it to sign in anymore."
                  },
                  class: 'btn btn-sm btn-destructive btn-muted whitespace-nowrap' do %>
                <%= inline_svg_tag 'icons/trash.svg', class: 'size-4 shrink-0' %>
                <span>Delete</span>
              <% end %>
            </li>
          <% end %>
        </ul>
      <% else %>
        <div class="card text-center">
          <div class="mx-auto size-16 mb-4 rounded-full bg-neutral-100 dark:bg-neutral-800 flex items-center justify-center">
            <%= inline_svg_tag 'icons/fingerprint.svg', class: 'size-8 text-muted' %>
          </div>
          <h3 class="subheading">No Passkeys</h3>
          <p class="text-soft mt-1 mb-4">You haven't registered any passkeys yet. Create your first passkey to enable secure, passwordless sign-in.</p>
          <%= link_to new_passkey_path, class: 'btn btn-primary gap-1.5 inline-flex' do %>
            <%= inline_svg_tag 'icons/plus.svg', class: 'size-4 shrink-0' %>
            <span>New Passkey</span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Active Sessions Section -->
  <div class="mb-4 flex flex-wrap items-end justify-between gap-2">
    <div>
      <h1 class="subheading">Active Sessions</h1>
      <span class="text-sm text-muted mt-1">
        <%= pluralize(@sessions.size, 'active session') %>
      </span>
    </div>

    <%= button_to destroy_other_sessions_path,
        method: :delete,
        data: { turbo_confirm: 'Are you sure you want to terminate all other sessions? This will log you out of all your devices except this one.' },
        class: 'btn btn-destructive' do %>
      <%= inline_svg_tag 'icons/logout.svg', class: 'size-5 shrink-0' %>
      <span>Log Out All</span>
    <% end %>
  </div>

  <div class="@container">
    <ul class="flex flex-col gap-2">
      <% @sessions.each do |session| %>
        <li class="card flex justify-between" style='view-transition-name: session<%= session.id %>'>
          <div>
            <div>
              <span class="font-semibold">
                <%
                  detector = DeviceDetector.new(session.user_agent)
                  browser = detector.name
                  os = detector.os_name
                  device = detector.device_type
                %>
                <%= "#{browser} on #{os}" %> <span class="text-sm text-muted font-normal">(<%= device %>)</span>
              </span>
              <%= tag.span('Current Session', class: 'ml-0.5 tag tag-accepted') if session == Current.session %>
            </div>
            <div class="mt-2">
              <p class="text-xs text-muted">IP Address: <span class="font-semibold text-soft"><%= session.ip_address %></span></p>
              <p class="text-xs text-muted">Logged in: <span class="font-semibold text-soft"><%= session.created_at.now? ? 'now' : local_time(session.created_at) %></span></p>
              <p class="text-xs text-muted">Last active: <span class="font-semibold text-soft"><%= session.updated_at.now? ? 'now' : "#{time_ago_in_words session.updated_at} ago" %></span> (<%= local_time session.updated_at %>)</p>
            </div>
          </div>

          <%= button_to session_path(session: session),
              method: :delete,
              data: { turbo_confirm: "Are you sure you want to terminate #{session == Current.session ? 'your current' : 'this'} session?" },
              class: 'btn btn-sm btn-destructive btn-muted whitespace-nowrap' do %>
              <%= inline_svg_tag 'icons/logout.svg', class: 'size-4 shrink-0' %>
              <span>Log Out</span>
          <% end %>
        </li>
      <% end %>
    </ul>
  </div>
</div>
